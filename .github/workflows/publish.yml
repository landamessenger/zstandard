name: Publish new version

on:
  workflow_run:
    workflows: ["Update files"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  platform_interface_analyze:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Analyze Platform Interface
    runs-on: [self-hosted, macOS]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_platform_interface
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_platform_interface
        run: flutter analyze

  platform_interface_test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Test Platform Interface
    runs-on: [self-hosted, macOS]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_platform_interface
        run: flutter pub get

      - name: Test check
        working-directory: zstandard_platform_interface
        run: flutter test

  platform_interface_publish_dry_run:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Dry Run Publish Platform Interface
    runs-on: [self-hosted, macOS]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_platform_interface
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_platform_interface
        run: dart pub publish --dry-run

  platform_interface_publish:
    name: Publish Platform Interface
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_analyze, platform_interface_test, platform_interface_publish_dry_run]
    outputs:
      version: ${{ steps.read_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_platform_interface
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_platform_interface
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_platform_interface.zip ./zstandard_platform_interface

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_platform_interface.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for dependency to be available
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 200
          command: cd zstandard_android && flutter pub get

      - name: Wait a minute
        run: sleep 120

  android_analyze:
    name: Analyze Android
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_android
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_android
        run: flutter analyze

  android_test:
    name: Test Android
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_android
        run: flutter pub get

      - name: Test check
        working-directory: zstandard_android
        run: flutter test

  android_publish_dry_run:
    name: Dry Run Publish Android
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_android
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_android
        run: dart pub publish --dry-run

  android_publish:
    name: Publish Android
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, android_analyze, android_test, android_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_android
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_android
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_android.zip ./zstandard_android

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_android.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios_analyze:
    name: Analyze iOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_ios
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_ios
        run: flutter analyze

  ios_test:
    name: Test iOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_ios
        run: flutter pub get

      - name: Test check
        working-directory: zstandard_ios
        run: flutter test

  ios_publish_dry_run:
    name: Dry Run Publish iOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_ios
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_ios
        run: dart pub publish --dry-run

  ios_publish:
    name: Publish iOS
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, ios_analyze, ios_test, ios_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_ios
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_ios
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_ios.zip ./zstandard_ios

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_ios.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  macos_analyze:
    name: Analyze macOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_macos
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_macos
        run: flutter analyze

  macos_test:
    name: Test macOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Test check
        working-directory: zstandard_macos
        run: flutter test

  macos_publish_dry_run:
    name: Dry Run Publish macOS
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_macos
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_macos
        run: dart pub publish --dry-run

  macos_publish:
    name: Publish macOS
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, macos_analyze, macos_test, macos_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_macos
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_macos
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_macos.zip ./zstandard_macos

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_macos.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows_analyze:
    name: Analyze Windows
    runs-on: [self-hosted, Windows]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Get dependencies
        working-directory: zstandard_windows
        shell: cmd
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_windows
        shell: cmd
        run: flutter analyze

  windows_test:
    name: Test Windows
    runs-on: [self-hosted, Windows]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Get dependencies
        working-directory: zstandard_windows
        shell: cmd
        run: flutter pub get

  windows_publish_dry_run:
    name: Dry Run Publish Windows
    runs-on: [self-hosted, Windows]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Get dependencies
        working-directory: zstandard_windows
        shell: cmd
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_windows
        shell: cmd
        run: dart pub publish --dry-run

  windows_publish:
    name: Publish Windows
    runs-on: [self-hosted, Windows]
    needs: [platform_interface_publish, windows_analyze, windows_test, windows_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Get dependencies
        working-directory: zstandard_windows
        shell: cmd
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_windows
        shell: cmd
        run: dart pub publish -f

      - name: Compress folder
        shell: cmd
        run: tar -a -c -f zstandard_windows.zip zstandard_windows

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{needs.platform_interface_publish.outputs.version}}"
          files: "./zstandard_windows.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux_analyze:
    name: Analyze Linux
    runs-on: [self-hosted, Linux]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_linux
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_linux
        run: flutter analyze

  linux_test:
    name: Test Linux
    runs-on: [self-hosted, Linux]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_linux
        run: flutter pub get

  linux_publish_dry_run:
    name: Dry Run Publish Linux
    runs-on: [self-hosted, Linux]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_linux
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_linux
        run: dart pub publish --dry-run

  linux_publish:
    name: Publish Linux
    runs-on: [self-hosted, Linux]
    needs: [platform_interface_publish, linux_analyze, linux_test, linux_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_linux
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_linux
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_linux.zip ./zstandard_linux

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_linux.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  web_analyze:
    name: Analyze Web
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_web
        run: flutter pub get

      - name: Analyze check
        working-directory: zstandard_web
        run: flutter analyze

  web_test:
    name: Test Web
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_web
        run: flutter pub get

      - name: Test check
        working-directory: zstandard_web
        run: flutter test

  web_publish_dry_run:
    name: Dry Run Publish Web
    runs-on: [self-hosted, macOS]
    needs: platform_interface_publish
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_web
        run: flutter pub get

      - name: Publish Dry Run
        working-directory: zstandard_web
        run: dart pub publish --dry-run

  web_publish:
    name: Publish Web
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, web_analyze, web_test, web_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_web
        run: flutter pub get

      - name: Publish
        working-directory: zstandard_web
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_web.zip ./zstandard_web

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_web.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cli_analyze:
    name: Analyze CLI
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_cli
        run: dart pub get

      - name: Analyze check
        working-directory: zstandard_cli
        run: dart analyze

  cli_test:
    name: Test CLI
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_cli
        run: dart pub get

      - name: Test check
        working-directory: zstandard_cli
        run: dart test

  cli_publish_dry_run:
    name: Dry Run Publish CLI
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_cli
        run: dart pub get

      - name: Publish Dry Run
        working-directory: zstandard_cli
        run: dart pub publish --dry-run

  cli_publish:
    name: Publish CLI
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, cli_analyze, cli_test, cli_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard_cli
        run: dart pub get

      - name: Publish
        working-directory: zstandard_cli
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard_cli.zip ./zstandard_cli

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard_cli.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  zstandard_analyze:
    name: Analyze Zstandard
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Wait for dependency to be available
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 200
          command: cd zstandard && flutter pub get

      - name: Wait a minute
        run: sleep 120

      - name: Analyze check
        working-directory: zstandard
        run: flutter analyze

  zstandard_test:
    name: Test Zstandard
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Wait for dependency to be available
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 200
          command: cd zstandard && flutter pub get

      - name: Wait a minute
        run: sleep 120

      - name: Test check
        working-directory: zstandard
        run: flutter test

  zstandard_publish_dry_run:
    name: Dry Run Publish Zstandard
    runs-on: [self-hosted, macOS]
    needs: [android_publish, ios_publish, web_publish, macos_publish, linux_publish, windows_publish]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Wait for dependency to be available
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 200
          command: cd zstandard && flutter pub get

      - name: Wait a minute
        run: sleep 120

      - name: Publish Dry Run
        working-directory: zstandard
        run: dart pub publish --dry-run

  zstandard_publish:
    name: Publish Zstandard
    runs-on: [self-hosted, macOS]
    needs: [platform_interface_publish, zstandard_analyze, zstandard_test, zstandard_publish_dry_run]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Read version from CHANGELOG.md
        id: read_version
        run: |
          VERSION=$(grep '^## ' CHANGELOG.md | head -n 1 | sed 's/^## //')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - uses: subosito/flutter-action@v1
        with:
          channel: 'stable'
          flutter-version: '3.35.6'

      - name: Get dependencies
        working-directory: zstandard
        run: flutter pub get

      - name: Publish
        working-directory: zstandard
        run: dart pub publish -f

      - name: Compress folder
        run: zip -r zstandard.zip ./zstandard

      - name: Upload asset to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          files: "./zstandard.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
